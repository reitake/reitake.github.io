---
title: Excel VBA Notes
tags: [Excel, VBA, Note]
categories: 「语言」
permalink: Excel-VBA
date: 2020-12-15 16:00:00
---
<center> <font color="#bababa">
***提高工作效率吧打工人***

</font> </center>
<!--more-->

---

# 基础

## 入门方法

### 录制宏

`视图`→`宏`→`录制宏`  / `开发工具`  

`Alt+F11`查看录制内容  

## 参考教程

[懒人Excel - VBA教程](https://www.lanrenexcel.com/excel-vba-tutorial/)

## 基本概念

### VBE编辑器 Visual Basic Editor

`Alt+F11`进入编辑器

### 注释

以英文单引号`‘`开头 。  

### 宏

可运行的VBA代码块。  

### 对象

对象是一个物，它可以是一个事、一个物体、一个概念、一个名词。对象包含描述静态信息的**属性**和对对象可以操作的**方法**。  

以生活中的对象为例子，汽车是一个对象。汽车的车牌号、油量、里程等是汽车的属性；开车、加油、换车牌等是汽车的方法。  

**常用Excel对象**  

- `Application 对象`，表示 Excel 应用程序。
- `Workbook 对象`，表示工作簿对象。
- `Worksheet 对象`，表示工作表对象
- `Range 对象`，表示单元格区域对象。

### 模块

模块是包含一个或多个过程或函数的内部组件。一个工作簿内包含的模块数量没有限制，一个模块内包含的过程或函数数量也没有限制。<u>模块用来作为保存过程或函数的容器</u>，这些过程和函数通常应用于整个工作簿。  

通过把多个过程和函数，合理的放置在不同的模块，可以使整个 VBA 代码逻辑更清晰、更易于阅读和理解。  

### 用户窗体

VBA和用户交互的界面，最基本的窗体控件包括：  

- 文本控件
- 按钮控件
- 列表控件
- 输入控件

### 「开发工具」选项卡

功能区中右键→「自定义功能区」→√「开发工具」  

## Excel VBA设置宏安全性

默认情况下，为防止来源不明的工作簿自带宏自动运行，Excel 会禁用宏的运行。  

### 宏安全性

「开发工具」选项卡→「宏安全性」→打开信任中心：  

- **禁用所有宏，并且不通知**：无法运行打开的工作簿内的 VBA 代码，Excel 也不会提示工作簿包含代码。
- **禁用所有宏，并发出通知**：默认状态下，无法运行 VBA 代码。但是 Excel 在打开包含 VBA 代码的工作簿时，在编辑栏上方，显示安全警告，并且可以选择启用代码运行或不启用。如果选择启用，下次打开相同的工作簿，不会出现警告。
- **禁用无数字签署的所有宏**：宏将被禁用，但如果存在宏，则会显示安全警告。但是，如果受信任发布者对宏进行了数字签名，并且您已经信任该发布者，则可运行该宏。如果您尚未信任该发布者，则会通知您启用签署的宏并信任该发布者。
- **启用所有宏(不推荐；可能会运行有潜在危险的代码)**：可以运行所有宏。一般不推荐选择此选项。

安全起见，可以采取：

- 禁用所有宏，并发出通知。
- 在电脑上创建一个用于存放信任的包含代码的工作簿的文件夹，将此工作簿添加到受信任为位置。
  - 把一个文件夹添加到 Excel 受信任的位置后，该文件夹下的包含 VBA 代码的工作簿打开时，不会提示安全警告，也无需每次手动开启代码。
  - 在开发工具选项卡，点击「宏安全性」按钮，弹出信任中心窗口，在左侧列表中，选择「受信任位置」。点击下方的「添加新位置」按钮，添加自己信任的一个文件夹。

## Excel 保存包含 VBA 代码的工作簿

2003 及之前的版本中，在 `xls`类型工作簿可以任意编写并保存 VBA 代码。  

2007 版本开始，第一次保存包含 VBA 代码的工作簿时，Excel 会提示“无法保存工作簿”。  

含 VBA 代码的工作簿，必须保存成启用宏的工作簿类型。Excel 为此提供了`xlsm`类型的工作簿，称之为「**启用宏的工作簿**」。

## 使用VBA 编辑器进行 Excel VBA 开发

### 打开方法

- 方法一：「开发工具」选项卡→`Visual Basic`
- 方法二：工作表右键菜单→`查看代码(V)`
- 方法三：快捷键`Alt + F11`

### 编辑器模块

- **工具栏**：编辑器命令栏，与 Excel 功能区域类似，包含 Excel VBA 开发相关的命令。
- **VBA 工程**：显示当前 VBA 工程包含的所有对象。通常，一个工作簿就是一个 VBA 工程，其中包括 Excel 对象、工作表对象、模块等。
- **属性窗口**：查看和设置选中对象的属性的窗口。
- **代码编辑窗口**：实际编写代码的位置。编写、修改、保存代码，都在这里进行。
- **立即窗口**：代码运行过程中，打印出的内容，在立即窗口中显示。一般用于调试代码

### 运行VBA代码

- 方法一：VBA编辑器工具栏「运行」→「运行子过程」
- 方法二：VBA编辑器快捷工具栏的播放图标
- 方法三：快捷键`F5`
- 方法四：给`图形`或者`按钮`指定宏，点击运行

# VBA 变量、类型、运算符

## 变量

VBA变量时一个存储数据的VBA代码接口，可存储、改变、参与计算  

- **变量名**：代表变量的名称
- **变量类型**：变量存储的数据的类型，例如数字、文本、逻辑值等

### 声明变量

```vb
Dim [变量名] As [数据类型]
```

### 变量命名  

- 首字母必须以字母开头。
- 不能包含空格、.(英文句号)、!(感叹号)、@、&、$、# 等字符。
- 长度不能超过 255 个字符。
- 不能使用 VBA 中保存的关键词作为变量名。

> 驼峰命名法：当变量名或函数名是由一个或多个单词连结在一起，而构成的唯一识别字时**，第一个单词以小写字母开始；从第二个单词开始以后的每个单词的首字母都采用大写字母。**
>
> 例如：myFirstName、myLastName，这样的变量名看上去就像骆驼峰一样此起彼伏，故得名。

### 变量类型

三大类数据类型：数字类型、非数字类型、通用类型。  

**数字类型**： 

| 类型     | 说明         | 数据范围                                                     |
| -------- | ------------ | ------------------------------------------------------------ |
| Byte     | 字节         | 0 至 255                                                     |
| Integer  | 整数         | -32,768 至 32,767                                            |
| Long     | 长整数       | -2,147,483,648 至 2,147,483,648                              |
| Single   | 单精度浮点数 | 在表示负数时： -3.402823E38 ~ -1.401298E-45 在表示正数时： 1.401298E-45 ~ 3.402823E38 |
| Double   | 双精度浮点数 | 在表示负数时： -1.79769313486231E308 ~ -4.94065645841247E-324 在表示正数时： 4.94065645841247E-324 ~ 1.79769313486231E308 |
| Currency | 货币         | -922,337,203,685,477.5808 至 922,337,203,685,477.5807        |
| Decimal  | 定点数       | 未放置定点数： +/- 79,228,162,514,264,337,593,543,950,335 放置定点数： +/- 7.9228162514264337593543950335 |

**非数字类型**：  

非数字变量通常不能直接参与算术运算。  

| 类型    | 说明       | 数据范围                                                |
| ------- | ---------- | ------------------------------------------------------- |
| String  | 文本类型   | 0 至 20亿字符                                           |
| Boolean | 逻辑值     | True 或 False                                           |
| Date    | 日期和时间 | 时间：00:00:00 至 23:59:59 日期： 100-1-1 至 9999-12-31 |
| Object  | 对象       | VBA 和 Excel 对象                                       |

**通用类型**：  

可存储任何类型的数据。在程序运行过程，VBA 可以自动识别数据类型，参与计算。  

| 类型    | 说明     | 数据范围 |
| ------- | -------- | -------- |
| Variant | 任意类型 | 不限     |

Variant 类型虽然灵活，但是它会占用更多内存空间，执行效率也会受影响。因此建议，在明确知道数据是何种类型时，指定数据类型；如果数据类型是可变的或不明确，使用 Variant 类型。

### 给变量赋值

```vb
[变量名] = [数据]
```

## 常量

在声明时就要指定值。  

```vb
Const [常量名] As [数据类型] = [值]
```

### 常量类型

与变量相同。  

## 运算符

### 赋值运算符

| 运算符 | 说明       | 示例               |
| ------ | ---------- | ------------------ |
| =      | 给变量赋值 | name = “Zhang San” |

### 算术运算符

假设 `a = 10`，`b = 3`，`->` 表示结果。  

| 运算符    | 说明                 | 示例          |
| --------- | -------------------- | ------------- |
| +         | 两数相加             | a + b -> 13   |
| –         | 两数相减             | a – b -> 7    |
| *         | 两数相乘             | a * b -> 30   |
| /         | 两数相除             | a / b -> 2.5  |
| \         | 两数相除，取整数部分 | a \ b -> 3    |
| Mod       | 两数相除，取余数     | a Mod b -> 1  |
| ^         | 幂运算               | a ^ b -> 1000 |
| -（取负） | 对数字取负           | -a -> -10     |

### 比较运算符

假设 `a = 10`，`b = 3`，`->` 表示结果。

| 运算符 | 说明               | 示例            |
| ------ | ------------------ | --------------- |
| =      | 比较两个值是否相等 | a = b -> False  |
| >      | 大于               | a > b -> True   |
| >=     | 大于等于           | a >= b => False |
| <      | 小于               | a < b -> False  |
| <=     | 小于等于           | a <= b -> False |
| <>     | 不等于             | a <> b -> True  |

### 逻辑运算符

逻辑运算符对逻辑值，即 True 和 False，进行逻辑运算，返回运算结果，运算结果也是逻辑值。

假设 `a = True`，`b = False`，`->` 表示结果。

| 运算符 | 说明                                          | 示例             |
| ------ | --------------------------------------------- | ---------------- |
| And    | 逻辑与，两个表达式都是真，返回 True。         | a And b -> False |
| Or     | 逻辑或，两个表达式至少有一个为真，返回 True。 | a Or b -> True   |
| Not    | 逻辑否，对逻辑表达式取否                      | Not a -> False   |
| Xor    | 逻辑异或，如果两个表达式不相同，返回 True     | a Xor b -> True  |

### 连接运算符

VBA 中的连接运算符用于连接 2 个或多个文本。其用法与 Excel 公式中的 & 符号相同。

| 运算符 | 说明         | 示例                                 |
| ------ | ------------ | ------------------------------------ |
| &      | 连接两个文本 | “Zhang” & ” ” & “San” -> “Zhang San” |

### 其他操作符

## 其他操作符

| 运算符        | 说明                 |
| ------------- | -------------------- |
| _ (下划线)    | 将一行代码分解成两行 |
| : ( 英文冒号) | 将两行代码放置在一行 |

## 数据类型

### 文本类型

| 类型   | 说明     | 数据范围      |
| ------ | -------- | ------------- |
| String | 文本类型 | 0 至 20亿字符 |

```vb
Dim name As String
name = "Zhang San"
name = "101"
name = Range("A1")
```

### 数字类型

选择合适的数字类型：如果小数字使用大范围数字类型存储，会浪费计算机内存；如果大数字使用小范围的数字类型存储，VBA 会自动转换成对应小范围数字，导致数字丢失精度。  

| 类型     | 说明         | 数据范围                                                     |
| -------- | ------------ | ------------------------------------------------------------ |
| Byte     | 比特         | 0 至 255                                                     |
| Integer  | 整数         | -32,768 至 32,767                                            |
| Long     | 长整数       | -2,147,483,648 至 2,147,483,648                              |
| Single   | 单精度浮点数 | 在表示负数时： -3.402823E38 ~ -1.401298E-45 在表示正数时： 1.401298E-45 ~ 3.402823E38 |
| Double   | 双精度浮点数 | 在表示负数时： -1.79769313486231E308 ~ -4.94065645841247E-324 在表示正数时： 4.94065645841247E-324 ~ 1.79769313486231E308 |
| Currency | 货币         | -922,337,203,685,477.5808 至 922,337,203,685,477.5807        |
| Decimal  | 定点数       | 未放置定点数： +/- 79,228,162,514,264,337,593,543,950,335 放置定点数： +/- 7.9228162514264337593543950335 |

```vb
Dim age as Integer
```

### 逻辑类型

| 类型    | 说明   | 数据范围      |
| ------- | ------ | ------------- |
| Boolean | 逻辑值 | True 或 False |

```vb
Dim isPass As Boolean
isPass = False
isPass = 70 >= 60
```

### 日期和时间类型

VBA 中的日期和时间使用数字表示，整数部分代表日期，小数部分代表时间。  

- 日期从 100-1-1 开始到 9999-12-31。
- 时间从 00:00:00 到 23:59:59。

```vb
Dim birthday As Date
Dim time As Date
```

给日期变量赋值时，可以直接把日期放置在两个 # 之间赋值，也可以使用数字，还可以把日期作为文本赋值：  

```vb
birthday = #2018-1-1#
birthday = 43101
birthday = "2018-1-1"

time = #12:00:00#
time = 0.5
time = "12:00:00"
```

### Variant 类型

Variant 类型是一种通用类型，可以表示任何一种类型的数据。它也是声明变量未指定数据类型时的默认类型。  

虽然 Variant 类型方便，但是相应的，占用更大的内存空间，也会影响程序运行效率。因此建议，在明确知道数据时何种类型时，指定数据类型；如果数据类型是可变的或不明确，使用 Variant 类型。  

# 程序结构

##  基本概念

### 过程

过程是 VBA 中，程序实际运行的最小结构。单独的一行或多行代码无法运行，必须把它们放置在一个过程里，才能运行。  

在示例中，`Sub 过程名()` 开头，`End Sub` 为结尾部分是一个过程的主题，其余代码需要放置在两者之间。  

```vb
Sub 过程名()
    
End Sub
```

### 程序语句

语句，是表示一个完整意思的一行代码。  

- **声明式语句**，也就是声明变量、常量、过程或者函数。
- **执行式语句**，执行指定动作。动作可以包括执行一个过程、开始一个循环、判断表达式等。
- **赋值语句**，给变量赋值，是执行式语句的特殊形式。

### VBA对象

### 程序运行结构

- 顺序结构
- 循环结构
- 判断结构

## 声明和赋值

声明变量，就是告诉 VBA，变量的名字和它所存储的值的数据类型。  

有4种变量：  

- **基本类型变量**。基本类型变量是那些存储单个数据的变量，例如数字、文本、日期等。

  - ```vb
    '语法
    Dim [变量名] As [数据类型]
    
    '实例
    Dim name As String
    Dim age As Integer
    Dim height As Double
    Dim birthday As Date
    ```

- **通用变量**。通用变量，即 Variant 类型变量。该变量的类型在程序运行过程中，根据赋值的数据自动指定。

  - ```vb
    '语法
    Dim [变量名] As Variant
    Dim [变量名]
    
    '实例
    Dim message As Variant
    Dim message
    ```

- **数组**。数组包含多个变量的集合。

  - ```vb
    '语法
    '固定长度数组声明
    Dim [变量名](开始序号 to 结束序号) As [数据类型]
    '动态数组声明
    Dim [变量名]() As [数据类型]
    
    '实例
    '声明包含10个文本类型元素的数组
    Dim names(1 to 10) As String
    '声明长度未知的文本类型数组
    Dim names() As String
    ```

- **对象**。对象包含一些列属性和方法。

  - ```vb
    '语法
    '前期绑定声明语法
    Dim [变量名] As [对象类型]
    '后期绑定声明语法
    Dim [变量名] As Object
    
    '实例
    Dim sh As Worksheet
    Dim car As Object
    ```

声明变量的语句，必须写在使用它的语句前。  

### 声明多个同类型变量  

```vb
'第一种，按两行写
Dim i As Integer
Dim j As Integer

'第二种，使用 : 符号，在一行写
Dim i As Integer : Dim j As Integer
```

### 不声明变量就使用

也可以，但非常不推荐，弊端：  

- 数据类型自动设置为 Variant 类型，效率低。
- 变量名写错，不会提示错误。
- 无法使用 VBA 代码自动补全。
- 数据类型不匹配时，不会提示错误。

**强制声明变量**：在模块头部写上：  

```vb
Option Explicit
```

### 基本类型变量的赋值

```vb
'语法，两种写法相同
Let [变量名] = [数据]
[变量名] = [数据]

'实例
Dim name As String
Let name = "Zhang San"

Dim age As Integer
Let age = 30

Dim birthday As Date
Let birthday = #2000-1-1#
```

在实际开发中，给基本类型变量赋值时，`Let`关键词可以忽略不写，直接以变量开头写赋值语句。  

### 数组类型变量赋值

```vb
'语法
[数组名](元素序号) = [数据]

'声明数组
Dim arr(1 to 5) As String
'数组赋值
arr(1) = "Zhang San"
arr(2) = "Li Si"
arr(3) = "Wang Wu"
```

### 对象类型变量的赋值

```vb
'语法
Set [变量名] = [对象类型数据]
    
'声明工作表类型的对象
Dim sheet As Worksheet
'将名称为“绩效表”的工作表，赋到 sheet 变量
Set sheet = Worksheets("绩效表")
```

**对象使用 `Set` 关键词，并且`Set`关键词不能省略。**  

由于对象可以包含多个属性，因此 VBA 提供一种同时给多个属性赋值的简单方法。具体方法是对象多个属性赋值语句，放置在 `With`+`对象`和`End With`关键词中间。  

```vb
Dim sheet As Worksheet
Set sheet = Worksheets("绩效表")

With sheet
    .Name = "旧绩效"
    .Visible = False
End With
```

